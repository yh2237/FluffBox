<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>FluffBox - Java version control</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link rel="stylesheet" href="./css/java.css">
    </head>
    <body>
        <div class="sidebar">
            <h2 class="logo-title">
                <img src="../icon/fluffbox.ico" width="40">
                <span>FluffBox</span>
            </h2>
            <div class="sidebar-button-group">
                <button id="sidebarNodeButton" class="sidebar-button">Node.js</button>
                <button id="sidebarPythonButton" class="sidebar-button">Python</button>
                <button id="sidebarJavaButton" class="sidebar-button active">Java</button>
            </div>
        </div>
        <div class="main-content">
            <div class="container">
                <h1>Java Versioning</h1>
                <div class="form-group">
                    <label for="versionSelect">Select the version you want to install or switch to:</label>
                    <select id="versionSelect" class="block w-full">
                        <option value="">Loading versions...</option>
                    </select>
                </div>
                <div class="button-group">
                    <button id="installButton">Install the selected version</button>
                    <button id="switchButton">Switch to the selected version</button>
                    <button id="deleteButton">Delete the selected version</button>
                </div>
                <div id="loadingMessage" class="hidden">Loading version list...</div>
                <div id="installedVersionsList" class="hidden">
                    <h2>Installed Version:</h2>
                    <ul id="installedList"></ul>
                </div>
                <br>
                <pre id="log"></pre>
                <button id="backButton">return</button>
            </div>
        </div>
        <script>
            const { ipcRenderer } = require('electron');
            const installButton = document.getElementById('installButton');
            const switchButton = document.getElementById('switchButton');
            const deleteButton = document.getElementById('deleteButton');
            const versionSelect = document.getElementById('versionSelect');
            const logElement = document.getElementById('log');
            const loadingMessage = document.getElementById('loadingMessage');
            const installedVersionsListDiv = document.getElementById('installedVersionsList');
            const installedListUl = document.getElementById('installedList');
            const backButton = document.getElementById('backButton');

            const sidebarNodeButton = document.getElementById('sidebarNodeButton');
            const sidebarPythonButton = document.getElementById('sidebarPythonButton');
            const sidebarJavaButton = document.getElementById('sidebarJavaButton');

            function setUIState(enabled) {
                versionSelect.disabled = !enabled;
                installButton.disabled = !enabled;
                switchButton.disabled = !enabled;
                deleteButton.disabled = !enabled;
                backButton.disabled = !enabled;
                sidebarNodeButton.disabled = false;
                sidebarPythonButton.disabled = false;
                sidebarJavaButton.disabled = false;
            }

            function updateInstalledVersionsUI(versions) {
                installedListUl.innerHTML = '';
                if (versions && versions.length > 0) {
                    versions.forEach(version => {
                        const li = document.createElement('li');
                        li.textContent = version;
                        installedListUl.appendChild(li);
                    });
                    installedVersionsListDiv.classList.remove('hidden');
                } else {
                    const li = document.createElement('li');
                    li.textContent = 'There is no version installed.';
                    installedListUl.appendChild(li);
                }
            }

            async function loadJavaVersions() {
                setUIState(false);
                loadingMessage.classList.remove('hidden');
                versionSelect.innerHTML = '<option value="">Loading versions...</option>';
                logElement.textContent = '';

                try {
                    const { available, installed } = await ipcRenderer.invoke('get-java-versions');
                    versionSelect.innerHTML = '';

                    if (available && available.length > 0) {
                        const defaultOption = document.createElement('option');
                        defaultOption.value = '';
                        defaultOption.textContent = 'Choose your version';
                        versionSelect.appendChild(defaultOption);

                        available.forEach(version => {
                            const option = document.createElement('option');
                            option.value = version;
                            option.textContent = version;
                            versionSelect.appendChild(option);
                        });
                    } else {
                        versionSelect.innerHTML = '<option value="">No version found available.</option>';
                        logElement.textContent += '❌ 利用可能なJavaバージョンが見つかりませんでした。\n';
                    }

                    updateInstalledVersionsUI(installed);

                } catch (error) {
                    versionSelect.innerHTML = '<option value="">バージョン読み込みエラー</option>';
                    logElement.textContent += `❌ Failed to get Java version list: ${error.message}\n`;
                } finally {
                    setUIState(true);
                    loadingMessage.classList.add('hidden');
                }
            }

            async function installJava() {
                const selectedVersion = versionSelect.value;
                if (!selectedVersion) {
                    logElement.textContent += '⚠️ Select the version you want to install.\n';
                    return;
                }

                setUIState(false);
                logElement.textContent = '';

                try {
                    logElement.textContent += `⚙️ Starting installation of Java ${selectedVersion}...\n`;
                    const result = await ipcRenderer.invoke('install-java-version', selectedVersion);
                    if (result === 'already_managed') {
                        logElement.textContent += `Java ${selectedVersion} is already installed.`;
                    } else {
                        logElement.textContent += `✅ Java ${selectedVersion} installation and activation completed.`;
                    }
                    await loadJavaVersions();
                } catch (error) {
                    logElement.textContent += `❌ An error occurred while installing Java: ${error.message}\n`;
                } finally {
                    setUIState(true);
                }
            }

            async function switchJavaVersion() {
                const selectedVersion = versionSelect.value;
                if (!selectedVersion) {
                    logElement.textContent += '⚠️ Select the version you want to switch to.\n';
                    return;
                }

                setUIState(false);
                logElement.textContent = '';

                try {
                    logElement.textContent += `⚙️ Beginning switch to Java ${selectedVersion}...\n`;
                    await ipcRenderer.invoke('switch-java-version', selectedVersion);
                    logElement.textContent += `✅ Switch to Java ${selectedVersion} completed.`;
                    await loadJavaVersions();
                } catch (error) {
                    logElement.textContent += `❌ An error occurred while switching Java versions: ${error.message}\n`;
                } finally {
                    setUIState(true);
                }
            }

            async function deleteJavaVersion() {
                const selectedVersion = versionSelect.value;
                if (!selectedVersion) {
                    logElement.textContent += '⚠️ Select the version you want to delete.\n';
                    return;
                }

                setUIState(false);
                logElement.textContent = '';

                try {
                    logElement.textContent += `⚙️ Starting removal of Java ${selectedVersion}...\n`;
                    await ipcRenderer.invoke('delete-java-version', selectedVersion);
                    logElement.textContent += `✅ Removal of Java ${selectedVersion} completed.`;
                    await loadJavaVersions();
                } catch (error) {
                    logElement.textContent += `❌ An error occurred while removing the Java version: ${error.message}\n`;
                } finally {
                    setUIState(true);
                }
            }

            backButton.addEventListener('click', () => {
                ipcRenderer.invoke('load-page', 'index');
            });

            document.addEventListener('DOMContentLoaded', loadJavaVersions);
            installButton.addEventListener('click', installJava);
            switchButton.addEventListener('click', switchJavaVersion);
            deleteButton.addEventListener('click', deleteJavaVersion);

            sidebarNodeButton.addEventListener('click', () => {
                ipcRenderer.invoke('load-page', 'nodejs');
            });
            sidebarPythonButton.addEventListener('click', () => {
                ipcRenderer.invoke('load-page', 'python');
            });
            sidebarJavaButton.addEventListener('click', () => {
            });

            ipcRenderer.on('java-log', (event, msg) => {
                logElement.textContent += msg + '\n';
                logElement.scrollTop = logElement.scrollHeight;
            });
        </script>
    </body>
</html>
