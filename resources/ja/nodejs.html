<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>FluffBox - Node.jsãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link rel="stylesheet" href="./css/nodejs.css">
    </head>
    <body>
        <div class="sidebar">
            <h2 class="logo-title">
                <img src="../icon/fluffbox.ico" width="40">
                <span>FluffBox</span>
            </h2>
            <div class="sidebar-button-group">
                <button id="sidebarNodeButton" class="sidebar-button active">Node.js</button>
                <button id="sidebarPythonButton" class="sidebar-button">Python</button>
                <button id="sidebarJavaButton" class="sidebar-button">Java</button>
            </div>
        </div>
        <div class="main-content">
            <div class="container">
                <h1>Node.js ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†</h1>
                <div class="form-group">
                    <label for="versionSelect">ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¾ãŸã¯åˆ‡ã‚Šæ›¿ãˆã‚’è¡Œã†ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’é¸æŠ:</label>
                    <select id="versionSelect" class="block w-full">
                        <option value="">ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’èª­ã¿è¾¼ã¿ä¸­...</option>
                    </select>
                </div>
                <div class="button-group">
                    <button id="installButton">é¸æŠã—ãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</button>
                    <button id="switchButton">é¸æŠã—ãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«åˆ‡ã‚Šæ›¿ãˆã‚‹</button>
                    <button id="deleteButton">é¸æŠã—ãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å‰Šé™¤</button>
                </div>
                <div id="loadingMessage" class="hidden">ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                <div id="installedVersionsList" class="hidden">
                    <h2>ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ãƒãƒ¼ã‚¸ãƒ§ãƒ³:</h2>
                    <ul id="installedList"></ul>
                </div>
                <br>
                <pre id="log"></pre>
                <button id="backButton">æˆ»ã‚‹</button>
            </div>
        </div>
        <script>
    const { ipcRenderer } = require('electron');
    const installButton = document.getElementById('installButton');
    const switchButton = document.getElementById('switchButton');
    const deleteButton = document.getElementById('deleteButton');
    const versionSelect = document.getElementById('versionSelect');
    const logElement = document.getElementById('log');
    const loadingMessage = document.getElementById('loadingMessage');
    const installedVersionsListDiv = document.getElementById('installedVersionsList');
    const installedListUl = document.getElementById('installedList');
    const backButton = document.getElementById('backButton');
    const sidebarNodeButton = document.getElementById('sidebarNodeButton');
    const sidebarPythonButton = document.getElementById('sidebarPythonButton');
    const sidebarJavaButton = document.getElementById('sidebarJavaButton');

    function setUIState(enabled) {
      versionSelect.disabled = !enabled;
      installButton.disabled = !enabled;
      switchButton.disabled = !enabled;
      deleteButton.disabled = !enabled;
      backButton.disabled = !enabled;
      sidebarNodeButton.disabled = false;
      sidebarPythonButton.disabled = false;
      sidebarJavaButton.disabled = false;
    }

    function updateInstalledVersionsUI(versions) {
        installedListUl.innerHTML = '';
        if (versions && versions.length > 0) {
            versions.forEach(version => {
                const li = document.createElement('li');
                li.textContent = version;
                installedListUl.appendChild(li);
            });
            installedVersionsListDiv.classList.remove('hidden');
        } else {
            const li = document.createElement('li');
            li.textContent = 'ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
            installedListUl.appendChild(li);
        }
    }

    async function loadNodeVersions() {
      setUIState(false);
      loadingMessage.classList.remove('hidden');
      versionSelect.innerHTML = '<option value="">ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’èª­ã¿è¾¼ã¿ä¸­...</option>';
      logElement.textContent = '';

      try {
        const { available, installed } = await ipcRenderer.invoke('get-node-versions');
        versionSelect.innerHTML = '';

        if (available && available.length > 0) {
          const defaultOption = document.createElement('option');
          defaultOption.value = '';
          defaultOption.textContent = 'ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„';
          versionSelect.appendChild(defaultOption);

          available.forEach(version => {
            const option = document.createElement('option');
            option.value = version;
            option.textContent = version;
            versionSelect.appendChild(option);
          });
        } else {
          versionSelect.innerHTML = '<option value="">åˆ©ç”¨å¯èƒ½ãªãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</option>';
          logElement.textContent += 'âŒ åˆ©ç”¨å¯èƒ½ãªNode.jsãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\n';
        }
        
        updateInstalledVersionsUI(installed);

      } catch (error) {
        versionSelect.innerHTML = '<option value="">ãƒãƒ¼ã‚¸ãƒ§ãƒ³èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</option>';
        logElement.textContent += `âŒ Node.jsãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒªã‚¹ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}\n`;
      } finally {
        setUIState(true);
        loadingMessage.classList.add('hidden');
      }
    }

    async function installNode() {
      const selectedVersion = versionSelect.value;
      if (!selectedVersion) {
        logElement.textContent += 'âš ï¸ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚\n';
        return;
      }

      setUIState(false);
      logElement.textContent = '';

      try {
        logElement.textContent += `Node.js ${selectedVersion} ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã®é–‹å§‹...\n`;
        const result = await ipcRenderer.invoke('install-node-version', selectedVersion);
        if (result === 'already_managed') {
            logElement.textContent += `Node.js ${selectedVersion} ã¯æ—¢ã«ã“ã®ãƒ„ãƒ¼ãƒ«ã§ç®¡ç†ã•ã‚Œã¦ã„ã¾ã™ã€‚`;
        } else {
            logElement.textContent += `ğŸ‰ Node.js ${selectedVersion} ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–ãŒå®Œäº†ã—ã¾ã—ãŸã€‚`;
        }
        await loadNodeVersions();
      } catch (error) {
        logElement.textContent += `âŒ Node.jsã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}\n`;
      } finally {
        setUIState(true);
      }
    }

    async function switchNodeVersion() {
      const selectedVersion = versionSelect.value;
      if (!selectedVersion) {
        logElement.textContent += 'âš ï¸ åˆ‡ã‚Šæ›¿ãˆã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚\n';
        return;
      }

      setUIState(false);
      logElement.textContent = '';

      try {
        logElement.textContent += `âš™ï¸ Node.js ${selectedVersion} ã¸ã®åˆ‡ã‚Šæ›¿ãˆã‚’é–‹å§‹ã—ã¾ã™...\n`;
        await ipcRenderer.invoke('switch-node-version', selectedVersion);
        logElement.textContent += `âœ… Node.js ${selectedVersion} ã¸ã®åˆ‡ã‚Šæ›¿ãˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚`;
        await loadNodeVersions();
      } catch (error) {
        logElement.textContent += `âŒ Node.jsãƒãƒ¼ã‚¸ãƒ§ãƒ³åˆ‡ã‚Šæ›¿ãˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}\n`;
      } finally {
        setUIState(true);
      }
    }

    async function deleteNodeVersion() {
        const selectedVersion = versionSelect.value;
        if (!selectedVersion) {
            logElement.textContent += 'âš ï¸ å‰Šé™¤ã™ã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚\n';
            return;
        }

        setUIState(false);
        logElement.textContent = '';

        try {
            logElement.textContent += `Node.js ${selectedVersion} ã®å‰Šé™¤ã‚’é–‹å§‹ã—ã¾ã™...\n`;
            await ipcRenderer.invoke('delete-node-version', selectedVersion);
            logElement.textContent += `âœ… Node.js ${selectedVersion} ã®å‰Šé™¤ãŒå®Œäº†ã—ã¾ã—ãŸã€‚`;
            await loadNodeVersions();
        } catch (error) {
            logElement.textContent += `âŒ Node.jsãƒãƒ¼ã‚¸ãƒ§ãƒ³å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}\n`;
        } finally {
            setUIState(true);
        }
    }

    backButton.addEventListener('click', () => {
      ipcRenderer.invoke('load-page', 'index');
    });

    document.addEventListener('DOMContentLoaded', loadNodeVersions);
    installButton.addEventListener('click', installNode);
    switchButton.addEventListener('click', switchNodeVersion);
    deleteButton.addEventListener('click', deleteNodeVersion);

    sidebarNodeButton.addEventListener('click', () => {
    });
    sidebarPythonButton.addEventListener('click', () => {
        ipcRenderer.invoke('load-page', 'python');
    });
    sidebarJavaButton.addEventListener('click', () => {
        ipcRenderer.invoke('load-page', 'java');
    });

    ipcRenderer.on('node-log', (event, msg) => {
      logElement.textContent += msg + '\n';
      logElement.scrollTop = logElement.scrollHeight;
    });
        </script>
    </body>
</html>
