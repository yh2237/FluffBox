<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>FluffBox - Pythonバージョン管理</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link rel="stylesheet" href="./css/python.css">
    </head>
    <body>
        <div class="sidebar">
            <h2 class="logo-title">
                <img src="../icon/fluffbox.ico" width="40">
                <span>FluffBox</span>
            </h2>
            <div class="sidebar-button-group">
                <button id="sidebarNodeButton" class="sidebar-button">Node.js</button>
                <button id="sidebarPythonButton" class="sidebar-button active">Python</button>
                <button id="sidebarJavaButton" class="sidebar-button">Java</button>
            </div>
        </div>
        <div class="main-content">
            <div class="container">
                <h1>Python バージョン管理</h1>
                <div class="form-group">
                    <label for="versionSelect">インストールまたは切り替えを行うバージョンを選択:</label>
                    <select id="versionSelect" class="block w-full">
                        <option value="">バージョンを読み込み中...</option>
                    </select>
                </div>
                <div class="button-group">
                    <button id="installButton">選択したバージョンをインストール</button>
                    <button id="switchButton">選択したバージョンに切り替える</button>
                    <button id="deleteButton">選択したバージョンを削除</button>
                </div>
                <div id="loadingMessage" class="hidden">バージョンリストを読み込み中...</div>
                <div id="installedVersionsList" class="hidden">
                    <h2>インストール済みバージョン:</h2>
                    <ul id="installedList"></ul>
                </div>
                <br>
                <pre id="log"></pre>
                <button id="backButton">戻る</button>
            </div>
        </div>
        <script>
            const { ipcRenderer } = require('electron');
            const installButton = document.getElementById('installButton');
            const switchButton = document.getElementById('switchButton');
            const deleteButton = document.getElementById('deleteButton');
            const versionSelect = document.getElementById('versionSelect');
            const logElement = document.getElementById('log');
            const loadingMessage = document.getElementById('loadingMessage');
            const installedVersionsListDiv = document.getElementById('installedVersionsList');
            const installedListUl = document.getElementById('installedList');
            const backButton = document.getElementById('backButton');
            const sidebarNodeButton = document.getElementById('sidebarNodeButton');
            const sidebarPythonButton = document.getElementById('sidebarPythonButton');
            const sidebarJavaButton = document.getElementById('sidebarJavaButton');

            function setUIState(enabled) {
                versionSelect.disabled = !enabled;
                installButton.disabled = !enabled;
                switchButton.disabled = !enabled;
                deleteButton.disabled = !enabled;
                backButton.disabled = !enabled;
                sidebarNodeButton.disabled = false;
                sidebarPythonButton.disabled = false;
                sidebarJavaButton.disabled = false;
            }

            function updateInstalledVersionsUI(versions) {
                installedListUl.innerHTML = '';
                if (versions && versions.length > 0) {
                    versions.forEach(version => {
                        const li = document.createElement('li');
                        li.textContent = version;
                        installedListUl.appendChild(li);
                    });
                    installedVersionsListDiv.classList.remove('hidden');
                } else {
                    const li = document.createElement('li');
                    li.textContent = 'インストール済みのバージョンはありません。';
                    installedListUl.appendChild(li);
                }
            }

            async function loadPythonVersions() {
                setUIState(false);
                loadingMessage.classList.remove('hidden');
                versionSelect.innerHTML = '<option value="">バージョンを読み込み中...</option>';
                logElement.textContent = '';

                try {
                    const { available, installed } = await ipcRenderer.invoke('get-python-versions');
                    versionSelect.innerHTML = '';

                    if (available && available.length > 0) {
                        const defaultOption = document.createElement('option');
                        defaultOption.value = '';
                        defaultOption.textContent = 'バージョンを選択してください';
                        versionSelect.appendChild(defaultOption);

                        available.forEach(version => {
                            const option = document.createElement('option');
                            option.value = version;
                            option.textContent = version;
                            versionSelect.appendChild(option);
                        });
                    } else {
                        versionSelect.innerHTML = '<option value="">利用可能なバージョンが見つかりませんでした。</option>';
                        logElement.textContent += '❌ 利用可能なPythonバージョンが見つかりませんでした。\n';
                    }

                    updateInstalledVersionsUI(installed);

                } catch (error) {
                    versionSelect.innerHTML = '<option value="">バージョン読み込みエラー</option>';
                    logElement.textContent += `❌ Pythonバージョンリストの取得に失敗しました: ${error.message}\n`;
                } finally {
                    setUIState(true);
                    loadingMessage.classList.add('hidden');
                }
            }

            async function installPython() {
                const selectedVersion = versionSelect.value;
                if (!selectedVersion) {
                    logElement.textContent += '⚠️ インストールするバージョンを選択してください。\n';
                    return;
                }

                setUIState(false);
                logElement.textContent = '';

                try {
                    logElement.textContent += `⚙️ Python ${selectedVersion} のインストールの開始...\n`;
                    const result = await ipcRenderer.invoke('install-python-version', selectedVersion);
                    if (result === 'already_managed') {
                        logElement.textContent += `Python ${selectedVersion} は既にこのツールで管理されています。`;
                    } else {
                        logElement.textContent += `✅ Python ${selectedVersion} のインストールとアクティブ化が完了しました。`;
                    }
                    await loadPythonVersions();
                } catch (error) {
                    logElement.textContent += `❌ Pythonインストール中にエラーが発生しました: ${error.message}\n`;
                } finally {
                    setUIState(true);
                }
            }

            async function switchPythonVersion() {
                const selectedVersion = versionSelect.value;
                if (!selectedVersion) {
                    logElement.textContent += '⚠️ 切り替えるバージョンを選択してください。\n';
                    return;
                }

                setUIState(false);
                logElement.textContent = '';

                try {
                    logElement.textContent += `⚙️ Python ${selectedVersion} への切り替えを開始します...\n`;
                    await ipcRenderer.invoke('switch-python-version', selectedVersion);
                    logElement.textContent += `✅ Python ${selectedVersion} への切り替えが完了しました。`;
                    await loadPythonVersions();
                } catch (error) {
                    logElement.textContent += `❌ Pythonバージョン切り替え中にエラーが発生しました: ${error.message}\n`;
                } finally {
                    setUIState(true);
                }
            }

            async function deletePythonVersion() {
                const selectedVersion = versionSelect.value;
                if (!selectedVersion) {
                    logElement.textContent += '⚠️ 削除するバージョンを選択してください。\n';
                    return;
                }

                setUIState(false);
                logElement.textContent = '';

                try {
                    logElement.textContent += `⚙️ Python ${selectedVersion} の削除を開始します...\n`;
                    await ipcRenderer.invoke('delete-python-version', selectedVersion);
                    logElement.textContent += `✅ Python ${selectedVersion} の削除が完了しました。`;
                    await loadPythonVersions();
                } catch (error) {
                    logElement.textContent += `❌ Pythonバージョン削除中にエラーが発生しました: ${error.message}\n`;
                } finally {
                    setUIState(true);
                }
            }

            backButton.addEventListener('click', () => {
                ipcRenderer.invoke('load-page', 'index');
            });

            document.addEventListener('DOMContentLoaded', loadPythonVersions);
            installButton.addEventListener('click', installPython);
            switchButton.addEventListener('click', switchPythonVersion);
            deleteButton.addEventListener('click', deletePythonVersion);

            sidebarNodeButton.addEventListener('click', () => {
                ipcRenderer.invoke('load-page', 'nodejs');
            });
            sidebarPythonButton.addEventListener('click', () => {
            });
            sidebarJavaButton.addEventListener('click', () => {
                ipcRenderer.invoke('load-page', 'java');
            });

            ipcRenderer.on('python-log', (event, msg) => {
                logElement.textContent += msg + '\n';
                logElement.scrollTop = logElement.scrollHeight;
            });
        </script>
    </body>
</html>
